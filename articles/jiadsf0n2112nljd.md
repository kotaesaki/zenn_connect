---
title: 'エンジニア1年生が行うGemアップデート手順'
emoji: '🐥'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['gem', 'rails', 'ruby']
published: false
---

# 自己紹介

エンジニア 1 年生 🐣(25)
大阪の自社開発企業で働いています

# はじめに

定期的なライブラリアップデートって大切ですよね！アップデートすれば新機能も増えて便利になるし、ライブラリを見ることはつまり自分たちのプロダクト外のソースコードを見る機会とも言えるので、積極的に行っていきたいものです。

関係ない話ですが、他の方の力を分けてもらってプロダクトに知見を分けてもらうオープンソースの価値観は素晴らしいと思っています。

しかし、日々の業務忙しくて手つけてらんねえ〜〜〜ってなるのもまた事実なわけですが、私の会社では UPDATE DAY と称して月一アップデートしかしない日を設けています。
UPDATE DAY を設ける以前はだいぶアップデートを後回しにしていたみたいで、10 ヶ月前まで Rails のバージョンも 4.2 でしたが、現在では 6.1 までバージョンを上げることができました。

まあそんなこんなで割と急ピッチで Rails 周りのアップデートをしていたので、だいぶ Gem アップデートの手順が定まってきたので忘れないように記事にしたいと思います。

こんなやり方あるぜ〜〜みたいなのも教えてください！🤪

いってみよう！

# 手順 1. アップデート対象になる Gem を一覧で表示

`bundle outdated`を行うことで、最新バージョンに追いついていない Gem を一覧で表示することができます。

# 手順 2. 対象の Gem を調査

まずは[RubyGems](https://rubygems.org/)から gem を検索します。
見る箇所としては、

- RUNTIME 依存と DEVELOPMENT 依存性
  - 依存 Gem のバージョンが足りない場合は上げることはできません。依存 Gem を先にあげられるならあげて、ムリそうだったら諦めます。
- 変更履歴
  - この項目はある Gem とない Gem が存在しますが、ない場合は Github に移動して`CHANGELOG.md`を見れば同じところに遷移できます。
  - 現状のバージョンとの差分をひとしきり確認していくのですが、特に注意深く見るのは機能追加と非推奨、そして機能削除です。私は Bugfixes や Refactor は目を通すくらいで済ませています。時間が許せばしっかり確認しますが。
    - 機能削除
      - remove などでカテゴライズされていることが多いです。これは問答無用で修正しなければいけない箇所で、修正が困難の場合は、どこかにコメントアウトなどで残しておいた方がいいでしょう。
    - 非推奨
      - deprecated ってやつですね。ここは今後削除される可能性がめちゃくちゃ高いので、今のうちに置き換えられそうならおきかえます。修正が困難の場合にリリースするかは時と場合によりますが、機能削除と同様にコメントかなにかで残しておいた方が良いと思います。
    - 機能追加
      - features など。今後使えそうな機能があればチームに共有してチームの知識として蓄えます。

# 手順 3. 実際にアップデートをする

`bundle update Gem名 --conservative`でアップデートします！

`--conservative`をつけない場合、依存関係にある Gem もアップデートされてしまうので、時と場合で使い分ける必要があります。私は基本的に`--conservative`つけています。

# 手順 4. 自動テスト実行!

自動テストで既存コードが正常に動くことを保証します。

またテストコードで賄えない Gem の影響範囲っぽい箇所は実際にシステムを目で見ながら確認もしていきます。

# 手順 5. Gem 単位でコミットする

これ結構大事だと思っているんですが、調査してテストを通ってももちろんリリース後にバグ出るみたいことはありえるのでそのリスクに備えなければいけません。

バグが発生した時に、対象の Gem だけを revert して取り消せるよう Gem 単位(もしくは取り消すことができる最小単位)でコミットするように意識しています。

ただこの方法が最善とも思っていなくて、より安全により影響範囲の少ないような方法を模索中です。

# 手順 2~手順 5 をループ

Gem を調査からコミットまでを対象の Gem 全てで行います。
すべてを最新にするのは無理だと思うので、そこはぐっとこらえましょう(実際アップデート作業していると多少強引にあげたくなるときもある。。笑)

# 終わりに

私自身こんなやり方、意識で毎月の UPDATE DAY に望んでいます！
もっといいやり方あれば是非教えていただけると嬉しいです！😎
